<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Species Map with Metadata</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
    .popup-content img {
      max-width: 150px;
      margin-top: 5px;
      display: block;
      cursor: pointer;
    }
    .popup-content {
      font-family: Arial, sans-serif;
      font-size: 14px;
      line-height: 1.3;
    }
    .leaflet-popup-content, .popup-content {
      user-select: text;
    }
    .cluster-grid {
      display: grid;
      gap: 10px;
    }
    .cluster-item {
      border: 1px solid #ccc;
      padding: 6px;
      border-radius: 6px;
      background: #f9f9f9;
    }
    .cluster-item img {
      max-width: 100%;
      margin-top: 5px;
      cursor: pointer;
    }
    .control-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: Arial, sans-serif;
      font-size: 14px;
    }
    .control-panel select, .control-panel button {
      margin-top: 5px;
      display: block;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="control-panel">
    <label for="taxonFilter">Taxon:</label>
    <select id="taxonFilter"><option value="all">All</option></select>
    <label for="locationFilter">Location:</label>
    <select id="locationFilter"><option value="all">All</option></select>
    <label for="sourceFilter">Source:</label>
    <select id="sourceFilter"><option value="all">All</option></select>
    <button id="toggleClustering">Disable Clustering</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script>
    const map = L.map("map").setView([22.3193, 114.1694], 11);
    L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png", {
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
      subdomains: "abcd",
      maxZoom: 20,
    }).addTo(map);

    const speciesData = [
      
      // add photo attributes here
      
    ];
    const clusterGroup = L.markerClusterGroup();
    const normalGroup = L.layerGroup();
    let clusteringEnabled = true;
    let isHoveringPopup = false;
    let popupTimeout = null;

    function createPopupContent(species) {
      return `<div class="popup-content">
        <strong>Accession:</strong> ${species.accession}<br/>
        <strong>Taxon:</strong> ${species.taxon}<br/>
        <strong>Location (eng):</strong> ${species.loci_eng}<br/>
        <strong>Location (chi):</strong> ${species.loci_chi}<br/>
        <strong>Coordinates (lat/long):</strong> ${species.coord}<br/>
        <strong>Source:</strong> ${species.source}<br/>
        <strong>Observed:</strong> ${species.date}<br/>
        <strong>Link:</strong> <a href="${species.link}" target="_blank">${species.link}</a><br/>
        <strong>Description:</strong> ${species.desc}<br/>
        <a href="${species.photo}" target="_blank">
          <img src="${species.photo}" alt="${species.taxon} photo"/>
        </a>
      </div>`;
    }

    function generateMarkers(data, group) {
      group.clearLayers();
      data.forEach((species) => {
        const popupContent = createPopupContent(species);
        const marker = L.marker([species.lat, species.lng])
          .bindPopup(popupContent)
          .on("mouseover", function () {
            this.openPopup();
          })
          .on("mouseout", function () {
            if (!isHoveringPopup) popupTimeout = setTimeout(() => this.closePopup(), 300);
          });
        group.addLayer(marker);
      });
    }

    function updateFilters() {
      const taxonSet = new Set();
      const locationSet = new Set();
      const sourceSet = new Set();
      speciesData.forEach(s => {
        taxonSet.add(s.taxon);
        locationSet.add(s.loci_eng);
        sourceSet.add(s.source);
      });
      const taxonSelect = document.getElementById("taxonFilter");
      const locationSelect = document.getElementById("locationFilter");
      const sourceSelect = document.getElementById("sourceFilter");
      for (const t of taxonSet) taxonSelect.innerHTML += `<option value="${t}">${t}</option>`;
      for (const l of locationSet) locationSelect.innerHTML += `<option value="${l}">${l}</option>`;
      for (const s of sourceSet) sourceSelect.innerHTML += `<option value="${s}">${s}</option>`;
    }

    function filterAndRender() {
      const tVal = document.getElementById("taxonFilter").value;
      const lVal = document.getElementById("locationFilter").value;
      const sVal = document.getElementById("sourceFilter").value;
      const filtered = speciesData.filter(s =>
        (tVal === "all" || s.taxon === tVal) &&
        (lVal === "all" || s.loci_eng === lVal) &&
        (sVal === "all" || s.source === sVal));
      if (clusteringEnabled) {
        generateMarkers(filtered, clusterGroup);
        map.removeLayer(normalGroup);
        map.addLayer(clusterGroup);
      } else {
        generateMarkers(filtered, normalGroup);
        map.removeLayer(clusterGroup);
        map.addLayer(normalGroup);
      }
    }

    document.getElementById("taxonFilter").addEventListener("change", filterAndRender);
    document.getElementById("locationFilter").addEventListener("change", filterAndRender);
    document.getElementById("sourceFilter").addEventListener("change", filterAndRender);

    document.getElementById("toggleClustering").addEventListener("click", () => {
      clusteringEnabled = !clusteringEnabled;
      document.getElementById("toggleClustering").innerText = clusteringEnabled ? "Disable Clustering" : "Enable Clustering";
      filterAndRender();
    });

    map.on("popupopen", function (e) {
      const popupEl = e.popup.getElement();
      popupEl.addEventListener("mouseenter", () => {
        isHoveringPopup = true;
        clearTimeout(popupTimeout);
      });
      popupEl.addEventListener("mouseleave", () => {
        isHoveringPopup = false;
        popupTimeout = setTimeout(() => map.closePopup(), 300);
      });
    });

    clusterGroup.on("clustermouseover", function (a) {
      const markers = a.layer.getAllChildMarkers();
      const columns = Math.min(markers.length, 5);
      let content = `<div class="cluster-grid" style="grid-template-columns: repeat(${columns}, 1fr);">`;
      markers.forEach((m) => {
        content += `<div class="cluster-item">${m.getPopup().getContent()}</div>`;
      });
      content += "</div>";
      const popup = L.popup({ maxWidth: 1200, autoPan: false })
        .setLatLng(a.layer.getLatLng())
        .setContent(content)
        .openOn(map);
    });

    clusterGroup.on("clustermouseout", function () {
      if (!isHoveringPopup) {
        popupTimeout = setTimeout(() => map.closePopup(), 300);
      }
    });

    map.addLayer(clusterGroup);
    updateFilters();
    filterAndRender();
  </script>
</body>
</html>